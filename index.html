<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IMU Acceleration Data Dashboard</title>

  <!-- Pyodide, Plotly, D3, Stats.js -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/17/Stats.min.js"></script>

  <style>
    /* â”€â”€ BASE RESET & LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Inter, sans-serif; background: #1e3c72; color:#333; min-height:100vh; }
    .main-container { display:grid; grid-template-rows:auto 1fr; min-height:100vh; }
    h1,h3,h4 { margin-bottom:.5em; }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      background: linear-gradient(135deg,#667eea,#764ba2);
      padding:2em; text-align:center; position:relative; color:#fff; overflow:hidden;
    }
    .header h1 { font-size:2rem; text-shadow:0 2px 6px rgba(0,0,0,0.3); }
    .header p { opacity:.9; }
    .python-status {
      position:absolute; top:1em; right:1em;
      display:flex; align-items:center;
      background:rgba(255,255,255,0.2); padding:.5em 1em;
      border-radius:1em; backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.3); color:#fff;
      font-size:.85rem;
    }
    .status-indicator {
      width:10px; height:10px; border-radius:50%;
      background:#f39c12; animation:pulse 2s infinite; margin-right:.5em;
    }
    .status-indicator.ready { background:#2ecc71; animation:none; }
    .status-indicator.error { background:#e74c3c; animation:none; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }

    /* â”€â”€ DASHBOARD LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dashboard { display:grid; grid-template-columns:350px 1fr; background:#f5f7fa; }
    .sidebar {
      background:rgba(255,255,255,0.95); padding:2em;
      border-right:1px solid rgba(0,0,0,0.1); overflow-y:auto;
    }
    .charts-area { padding:2em; display:grid; grid-template-rows:1fr 1fr 1fr; gap:1.5em; }

    /* â”€â”€ CODE EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .python-section { margin-bottom:2em; }
    .code-editor { background:#1e1e1e; border-radius:.5em; overflow:hidden; }
    .code-editor textarea {
      width:100%; height:180px; padding:1em;
      background:transparent; border:none; outline:none;
      color:#d4d4d4; font-family:monospace; font-size:0.9em;
    }
    .run-python-btn {
      width:100%; padding:.75em; margin-top:.5em;
      background:linear-gradient(135deg,#2ecc71,#27ae60);
      border:none; border-radius:.5em; color:#fff;
      font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .run-python-btn:disabled { background:#95a5a6; cursor:not-allowed; }

    /* â”€â”€ STATS GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:1em; }
    .stat-card {
      background:rgba(255,255,255,0.8); padding:1em; border-radius:.5em;
      text-align:center; backdrop-filter:blur(8px); border:1px solid rgba(0,0,0,0.1);
    }
    .stat-value { font-size:1.5rem; font-weight:700; }
    .stat-label { opacity:.8; font-size:.85rem; }

    /* â”€â”€ DEVICE & TRACE CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .device-toggle,.trace-item {
      display:flex; align-items:center; padding:.5em; margin-bottom:.5em;
      border-radius:.5em; cursor:pointer; transition:background .2s,transform .2s;
    }
    .device-toggle:hover,.trace-item:hover { background:rgba(0,0,0,0.05); transform:translateY(-2px); }
    .device-checkbox,.trace-checkbox { margin-right:.75em; }
    .color-dot,.trace-color {
      width:16px; height:16px; border-radius:50%; margin-right:.75em;
      border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,0.2);
    }
    .device-name,.trace-name { font-weight:500; }

    /* â”€â”€ CHART CONTAINERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-container {
      background:#fff; border-radius:1em; padding:1.5em;
      box-shadow:0 8px 20px rgba(0,0,0,0.1); position:relative;
      overflow:hidden;
    }
    .chart-title { font-size:1.2rem; margin-bottom:1em; text-align:center; }
    .chart { width:100%; height:200px; }
    .loading-spinner {
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:40px; height:40px; border:4px solid #f3f3f3; border-top:4px solid #667eea;
      border-radius:50%; animation:spin 1s linear infinite; display:none;
    }
    @keyframes spin { to{transform:rotate(360deg);} }

    /* â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .action-buttons { display:flex; flex-direction:column; gap:.75em; margin-top:1.5em; }
    .btn { padding:.75em; border:none; border-radius:.5em; font-weight:600; cursor:pointer; }
    .btn-success { background:linear-gradient(135deg,#56ab2f,#a8e6cf); color:#fff; }
    .btn-secondary { background:linear-gradient(135deg,#6c757d,#495057); color:#fff; }
    .btn-secondary:disabled { background:#ccc; cursor:not-allowed; }

    /* â”€â”€ SMALL FOOTER MODS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media(max-width:1024px){
      .dashboard { grid-template-columns:1fr; }
      .charts-area { grid-template-rows: repeat(3,180px); }
    }
  </style>
</head>

<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="
      position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);
      display:flex;align-items:center;justify-content:center;z-index:1000;color:#333;">
    <div style="background:#fff;padding:2em;border-radius:1em;text-align:center;">
      <div class="loading-spinner" style="width:50px;height:50px;border-width:6px;margin:0 auto 1em;"></div>
      <h2>Loading Pythonâ€¦</h2>
      <p>This may take 30â€“60â€‰s on first load</p>
    </div>
  </div>

  <div class="main-container">
    <header class="header">
      <div class="python-status">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Initializing Pythonâ€¦</span>
      </div>
      <h1>ğŸ IMU Dashboard</h1>
      <p>Run your IMU-resampling code directly in the browser.</p>
    </header>

    <div class="dashboard">
      <aside class="sidebar">
        <!-- Python Code Editor -->
        <section class="python-section">
          <h3>ğŸ Python Code Editor</h3>

          <!-- Folder Upload -->
          <div style="margin-bottom:1em;">
            <label for="dataUpload">ğŸ“‚ Upload IMU â€œDataâ€ Folder:</label><br/>
            <input
              type="file"
              id="dataUpload"
              webkitdirectory
              directory
              multiple
              disabled
              style="margin-top:.5em;"
            />
          </div>

          <!-- Code Editor -->
          <div class="code-editor">
            <textarea id="pythonCode">
import numpy as np
import matplotlib.pyplot as plt

def generate_imu_data():
    t = np.linspace(0,10,4000)
    data = {
      'timestamp':t.tolist(),
      'accelerometer':{
        'x': (0.8*np.sin(2*np.pi*2*t)+0.1*np.random.randn(4000)).tolist(),
        'y': (0.6*np.cos(2*np.pi*2.5*t)+0.1*np.random.randn(4000)).tolist(),
        'z': (1.0+0.4*np.sin(2*np.pi*1.5*t)+0.1*np.random.randn(4000)).tolist()
      }
    }
    from types import SimpleNamespace
    def make_dev(name):
        return SimpleNamespace(
          serial_number=name,
          inertial=SimpleNamespace(
            timestamp=(np.array(data['timestamp'])*1e6),
            accelerometer=SimpleNamespace(
              x=np.array(data['accelerometer']['x']),
              y=np.array(data['accelerometer']['y']),
              z=np.array(data['accelerometer']['z'])
            )
          )
        )
    return [ make_dev("IMU-Alpha"), make_dev("IMU-Beta") ]

devices = generate_imu_data()
devices
            </textarea>
          </div>

          <button class="run-python-btn" id="runPythonBtn" onclick="runPythonCode()">â–¶ï¸ Run Python Code</button>
          <pre id="pythonOutput" style="display:none;background:#222;color:#f66;padding:1em;border-radius:.5em;margin-top:.5em;"></pre>
        </section>

        <!-- Data Statistics -->
        <section class="control-panel">
          <h3>ğŸ“Š Data Statistics</h3>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalPoints">0</div>
              <div class="stat-label">Data Points</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="duration">0â€‰s</div>
              <div class="stat-label">Duration</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="devices">0</div>
              <div class="stat-label">Devices</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="sampleRate">400â€‰Hz</div>
              <div class="stat-label">Sample Rate</div>
            </div>
          </div>
        </section>

        <!-- Device Toggles -->
        <section class="device-controls">
          <h3>ğŸ›ï¸ Device Controls</h3>
          <div id="deviceToggles"><em style="color:#666;">Run code to show devices</em></div>
        </section>

        <!-- Trace Toggles -->
        <section class="trace-controls">
          <h4>ğŸ“ˆ Trace Controls</h4>
          <div id="traceToggles"><em style="color:#666;">Run code to show traces</em></div>
        </section>

        <!-- Export & Clear -->
        <div class="action-buttons">
          <button class="btn btn-success" onclick="exportData()">ğŸ’¾ Export CSV</button>
          <button class="btn btn-secondary" id="clearBtn" onclick="clearData()" disabled>ğŸ—‘ï¸ Clear Data</button>
        </div>
      </aside>

      <!-- Charts -->
      <div class="charts-area">
        <div class="chart-container">
          <div class="chart-title">X-Axis Acceleration (G)</div>
          <div id="chartX" class="chart"></div>
          <div id="loadingX" class="loading-spinner"></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">Y-Axis Acceleration (G)</div>
          <div id="chartY" class="chart"></div>
          <div id="loadingY" class="loading-spinner"></div>
        </div>
        <div class="chart-container">
          <div class="chart-title">Z-Axis Acceleration (G)</div>
          <div id="chartZ" class="chart"></div>
          <div id="loadingZ" class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Monitor -->
  <div id="stats" style="position:fixed;top:10px;left:10px;z-index:10000;"></div>

  <script>
  // â”€â”€ GLOBALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let pyodide = null, deviceData = [], deviceVisibility = {}, traceVisibility = {}, pythonDataAvailable = false;
  const colorScheme = ['#667eea','#764ba2','#f39c12','#e74c3c','#2ecc71','#e67e22'];
  const plotlyConfig = {
    responsive:true, displayModeBar:true,
    modeBarButtonsToRemove:['pan2d','select2d','lasso2d','autoScale2d'],
    displaylogo:false,
    toImageButtonOptions:{format:'png',filename:'imu_data',height:500,width:1000,scale:2}
  };
  const plotlyLayout = {
    margin:{l:50,r:30,t:40,b:50},
    xaxis:{title:'Time (s)',gridcolor:'rgba(0,0,0,0.1)',zeroline:false},
    yaxis:{title:"G's",gridcolor:'rgba(0,0,0,0.1)',zeroline:true,zerolinecolor:'rgba(0,0,0,0.3)'},
    plot_bgcolor:'rgba(0,0,0,0)',paper_bgcolor:'rgba(0,0,0,0)',
    font:{family:'Inter, sans-serif',size:12,color:'#2c3e50'},
    hovermode:'x unified',
    legend:{orientation:'v',x:1.02,y:1,xanchor:'left',bgcolor:'rgba(255,255,255,0.8)',bordercolor:'rgba(0,0,0,0.1)',borderwidth:1}
  };

  // â”€â”€ STATUS UPDATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStatus(text,type='loading'){
    const txt = document.getElementById('statusText'),
          ind = document.getElementById('statusIndicator');
    txt.textContent=text;
    ind.classList.remove('ready','error');
    if(type==='ready') ind.classList.add('ready');
    if(type==='error') ind.classList.add('error');
  }

  // â”€â”€ INIT PYODIDE & MOCK ximu3csv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function initializePython(){
    try {
      pyodide = await loadPyodide({indexURL:'https://cdn.jsdelivr.net/pyodide/v0.24.1/full/'});
      updateStatus('Installing packagesâ€¦');
      await pyodide.loadPackage(['numpy']);
      pyodide.runPython(`
import sys
from types import ModuleType, SimpleNamespace
import numpy as np
ximu3csv = ModuleType('ximu3csv')
def mock_read(path):
    t = np.linspace(0,10,4000)
    data={'timestamp':t.tolist(),
          'accelerometer':{
            'x':(0.8*np.sin(2*np.pi*2*t)+0.1*np.random.randn(4000)).tolist(),
            'y':(0.6*np.cos(2*np.pi*2.5*t)+0.1*np.random.randn(4000)).tolist(),
            'z':(1.0+0.4*np.sin(2*np.pi*1.5*t)+0.1*np.random.randn(4000)).tolist()}
         }
    def make_dev(name):
        return SimpleNamespace(
            serial_number=name,
            inertial=SimpleNamespace(
                timestamp=(np.array(data['timestamp'])*1e6),
                accelerometer=SimpleNamespace(
                    x=np.array(data['accelerometer']['x']),
                    y=np.array(data['accelerometer']['y']),
                    z=np.array(data['accelerometer']['z'])
                )
            )
        )
    return [make_dev("IMU-Alpha"),make_dev("IMU-Beta")]
def mock_resample(devices,rate):
    return devices
ximu3csv.read=mock_read
ximu3csv.resample=mock_resample
sys.modules['ximu3csv']=ximu3csv
      `);
      // enable folder picker once ready
      document.getElementById('dataUpload').disabled = false;
      updateStatus('Python Ready','ready');
    } catch(e){
      console.error(e);
      updateStatus('Failed to load Python','error');
    } finally {
      document.getElementById('loadingOverlay').style.display='none';
    }
  }

  // â”€â”€ FILESYSTEM HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function mkdirTree(path){
    let parts=path.split('/'), curr='';
    for(let p of parts){
      curr+= '/'+p;
      try{ pyodide.FS.mkdir(curr); }catch{}
    }
  }

  document.getElementById('dataUpload').addEventListener('change', async evt=>{
    if(!pyodide) return alert("Python not ready");
    const files = evt.target.files;
    try{ pyodide.FS.mkdir('/Data'); }catch{}
    for(let file of files){
      const rel = file.webkitRelativePath;  // e.g. "Data/device1.csv"
      const full = '/'+rel;
      const dir = full.substring(0, full.lastIndexOf('/'));
      mkdirTree(dir);
      const buf = await file.arrayBuffer();
      pyodide.FS.writeFile(full, new Uint8Array(buf));
    }
    alert(`âœ… Uploaded ${files.length} files into /Data/`);
  });

  // â”€â”€ RUN USER CODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function runPythonCode(){
    updateStatus('Running codeâ€¦');
    try {
      const code = document.getElementById('pythonCode').value;
      const full = `
import ximu3csv
devices = ximu3csv.resample(ximu3csv.read("Data"),400)
${code}
`;
      const pyVal = pyodide.runPython(full);
      const jsVal = pyVal.toJs({dict:false});
      deviceData = jsVal;
      pythonDataAvailable = true;
      document.getElementById('clearBtn').disabled = false;
      updateStatus('Data Loaded','ready');
      updateStats(); renderDeviceControls(); renderTraceControls(); renderCharts();
    } catch(err){
      console.error(err);
      const out = document.getElementById('pythonOutput');
      out.textContent = err;
      out.style.display = 'block';
      updateStatus('Error','error');
    }
  }

  // â”€â”€ UPDATE STATISTICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateStats(){
    const ts = deviceData[0].inertial.timestamp.toJs();
    document.getElementById('totalPoints').textContent = ts.length * deviceData.length;
    document.getElementById('duration').textContent = ts[ts.length-1].toFixed(2)+'â€‰s';
    document.getElementById('devices').textContent = deviceData.length;
    document.getElementById('sampleRate').textContent = '400â€‰Hz';
  }

  // â”€â”€ DEVICE CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderDeviceControls(){
    const c = document.getElementById('deviceToggles');
    c.innerHTML = '';
    deviceData.forEach((dev,i)=>{
      const name = dev.serial_number;
      deviceVisibility[name] = true;
      const div = document.createElement('div'); div.className='device-toggle';
      const cb  = document.createElement('input'); cb.type='checkbox'; cb.checked=true; cb.className='device-checkbox';
      cb.onchange = ()=>{ deviceVisibility[name]=cb.checked; renderCharts(); renderTraceControls(); };
      const dot = document.createElement('div'); dot.className='color-dot'; dot.style.background=colorScheme[i%colorScheme.length];
      const lbl = document.createElement('div'); lbl.className='device-name'; lbl.textContent=name;
      div.append(cb,dot,lbl); c.append(div);
    });
  }

  // â”€â”€ TRACE CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTraceControls(){
    const c = document.getElementById('traceToggles');
    c.innerHTML = '';
    ['x','y','z'].forEach(axis=>{
      deviceData.forEach((dev,i)=>{
        const name = dev.serial_number;
        const key = `${name}-${axis}`;
        if(traceVisibility[key]===undefined) traceVisibility[key]=true;
        const div = document.createElement('div'); div.className='trace-item';
        const cb  = document.createElement('input'); cb.type='checkbox'; cb.checked=traceVisibility[key]; cb.className='trace-checkbox';
        cb.onchange = ()=>{ traceVisibility[key]=cb.checked; renderCharts(); };
        const dot = document.createElement('div'); dot.className='trace-color'; dot.style.background=colorScheme[i%colorScheme.length];
        const lbl = document.createElement('div'); lbl.className='trace-name'; lbl.textContent=`${name}/${axis.toUpperCase()}`;
        div.append(cb,dot,lbl); c.append(div);
      });
    });
  }

  // â”€â”€ RENDER PLOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderCharts(){
    ['X','Y','Z'].forEach((Comp,i)=>{
      const axis = Comp.toLowerCase(), cid=`chart${Comp}`, lid=`loading${Comp}`;
      document.getElementById(lid).style.display='block';
      const traces = [];
      deviceData.forEach((dev,j)=>{
        const name = dev.serial_number;
        if(!deviceVisibility[name]||!traceVisibility[`${name}-${axis}`]) return;
        const ary = dev.inertial.accelerometer[axis].toJs();
        const ts  = dev.inertial.timestamp.toJs().map(v=>v/1e6);
        traces.push({ x:ts, y:ary, name, mode:'lines', line:{color:colorScheme[j%colorScheme.length]} });
      });
      const layout = JSON.parse(JSON.stringify(plotlyLayout));
      layout.title = { text:`${Comp}-Axis Acceleration` };
      Plotly.newPlot(cid,traces,layout,plotlyConfig).then(_=>document.getElementById(lid).style.display='none');
    });
  }

  // â”€â”€ EXPORT CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function exportData(){
    if(!pythonDataAvailable) return;
    const ts = deviceData[0].inertial.timestamp.toJs().map(v=>v/1e6);
    const header = ['Time', ...deviceData.map(d=>d.serial_number).flatMap(n=>['X','Y','Z'].map(a=>`${n}-${a}`))].join(',');
    const lines = [header];
    ts.forEach((t,i)=>{
      const row = [t];
      deviceData.forEach(dev=>{
        const a = dev.inertial.accelerometer;
        row.push(a.x.toJs()[i], a.y.toJs()[i], a.z.toJs()[i]);
      });
      lines.push(row.join(','));
    });
    const blob = new Blob([lines.join('\n')], {type:'text/csv'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url; a.download='imu_data.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  // â”€â”€ CLEAR DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clearData(){
    deviceData=[]; pythonDataAvailable=false;
    document.getElementById('deviceToggles').innerHTML='<em style="color:#666;">Run code to show devices</em>';
    document.getElementById('traceToggles' ).innerHTML='<em style="color:#666;">Run code to show traces</em>';
    ['X','Y','Z'].forEach(c=>Plotly.purge(`chart${c}`));
    document.getElementById('clearBtn').disabled=true;
    updateStatus('Ready','ready');
  }

  // â”€â”€ PERFORMANCE MONITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const stats = new Stats(); stats.showPanel(0);
  document.getElementById('stats').appendChild(stats.dom);
  function animate(){ stats.begin(); stats.end(); requestAnimationFrame(animate); }
  requestAnimationFrame(animate);

  // â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  initializePython();
  </script>
</body>
</html>
